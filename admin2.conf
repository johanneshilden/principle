# -----------------------------------------------------------------------------
#      Authenticate a user.
# -----------------------------------------------------------------------------
GET    /user/:username/:password     -> 
                                                                              
        select id
             , username
             , name
             , role
             , password
        from sdrp_user
          where sdrp_user.username = {{:username}}
            and sdrp_user.password = {{:password}}

# -----------------------------------------------------------------------------
#      Retrieve all users.
# -----------------------------------------------------------------------------
GET    /user/all                     >>  (id, username, name, role, depotId, depotName)         

        select sdrp_user.id                                                  
             , sdrp_user.username                                            
             , sdrp_user.name                                                
             , sdrp_user.role
             , depot.id
             , depot.name
        from sdrp_user                                                       
          left join depot 
            on depot.id = sdrp_user.depot_id
        order by                                                             
          sdrp_user.id

# -----------------------------------------------------------------------------
#      Update a user.
# -----------------------------------------------------------------------------
PUT    /user/:id                     >< 

        update sdrp_user set name     = {{name}}                                     
                           , depot_id = {{depotId}}
          where id = {{:id}}

# -----------------------------------------------------------------------------
#      Insert a new user.
# -----------------------------------------------------------------------------
POST   /user                         <> 

        insert into sdrp_user (name, username, password, role, depot_id)
          values ( {{name}}
                 , {{username}}
                 , {{password}}
                 , {{role}}
                 , {{depotId}} )

# -----------------------------------------------------------------------------
#      Change a user's password.
# -----------------------------------------------------------------------------
PATCH  /user/:id/password            ><

        update sdrp_user set password = {{password}} 
          where id = {{:id}}

# -----------------------------------------------------------------------------
#      Delete a user.
# -----------------------------------------------------------------------------
DELETE /user/:id                     --                                       

        delete from sdrp_user
          where id = {{:id}}
            and id <> 1              # root user cannot be deleted

# -----------------------------------------------------------------------------
#      Retrieve all depots.
# -----------------------------------------------------------------------------
GET    /depot                        >>                                       

        ( id
        , latitude
        , longitude
        , name
        , regionId
        , regionName )
                                                                              
        select depot.id
             , depot.latitude
             , depot.longitude
             , depot.name
             , depot.region_id
             , region.name
        from depot                                                           
          join region 
            on region.id = depot.region_id
        order by depot.id

# -----------------------------------------------------------------------------
#      Update a depot.
# -----------------------------------------------------------------------------
PUT    /depot/:id                    ><
        
        update depot set latitude  = {{latitude}}
                       , longitude = {{longitude}}
                       , name      = {{name}}
          where id = {{:id}}

# -----------------------------------------------------------------------------
#      Detach currently assigned depot manager from a depot.
# -----------------------------------------------------------------------------
DELETE /depot-manager/~/depot/:id    --                                       

        update sdrp_user set depot_id = NULL 
          where depot_id = {{:id}}  
            and role = 'depot-manager'

# -----------------------------------------------------------------------------
#      Assign depot manager to a depot.
# -----------------------------------------------------------------------------
PATCH  /depot-manager/~/depot/:id    ><                                       

        update sdrp_user set depot_id = {{:id}}
          where id = {{userId}}
            and role = 'depot-manager'

# -----------------------------------------------------------------------------
#      Delete all area associations for a depot.
# -----------------------------------------------------------------------------
DELETE /area/~/depot/:id             --

        update area set depot_id = null 
          where depot_id = {{:id}}

# -----------------------------------------------------------------------------
#      Assign a depot to a collection of areas.
# -----------------------------------------------------------------------------
PATCH  /area/~/depot/:id             ><

        update area set depot_id = {{:id}}
          where area.id in 
            ( {{areas}} )

# -----------------------------------------------------------------------------
#      Create a depot.
# -----------------------------------------------------------------------------
POST   /depot                        <>                                       

        insert into depot 
          ( name
          , latitude
          , longitude
          , region_id
          ) values
          ( {{name}}
          , {{latitude}}
          , {{longitude}}
          , {{regionId}} )

# -----------------------------------------------------------------------------
#      Create a depot and its connected resources.
#
#      {
#        "name"           : string,
#        "latitude"       : number,
#        "longitude"      : number,
#        "areas"          : array,
#        "depotManagerId" : number,
#        "regionId"       : number
#      }
# -----------------------------------------------------------------------------
POST   /!depot                       |>
{
    "processors": [
        {
            "id"     : 1,
            "method" : "POST",
            "uri"    : "/depot",
            "fields" : ["name", "latitude", "longitude", "regionId"]
        },
        {
            "id"     : 2,
            "method" : "PATCH",
            "uri"    : "/depot-manager/~/depot/:id",
            "fields" : ["userId"]
        },
        {
            "id"     : 3,
            "method" : "PATCH",
            "uri"    : "/area/~/depot/:id",
            "fields" : ["areas"]
        }
    ],
    "connections": [
        {
            "destination": 1,
            "filters": [],
            "transformers": []
        },
        {
            "destination": 2,
            "filters": [],
            "transformers": [
                {
                    "action": "rename",
                    "arguments": ["depotManagerId", "userId"]
                }
            ]
        },
        {
            "destination": 3,
            "filters": [],
            "transformers": []
        },
        {
            "source": 1,
            "destination": 2,
            "filters": [
                {
                    "property": "status",
                    "predicate": "equalTo",
                    "value": true
                }
            ],
            "transformers": [
                {
                    "action": "rename",
                    "arguments": ["id", ":id"]
                }
            ]
        },
        {
            "source": 1,
            "destination": 3,
            "filters": [
                {
                    "property": "status",
                    "predicate": "equalTo",
                    "value": true
                }
            ],
            "transformers": [
                {
                    "action": "rename",
                    "arguments": ["id", ":id"]
                }
            ]
        },
        {
            "source": 1,
            "filters": [],
            "transformers": []
        },
        {
            "source": 2,
            "filters": [],
            "transformers": []
        },
        {
            "source": 3,
            "filters": [],
            "transformers": []
        }
    ]
}

# -----------------------------------------------------------------------------
#      Update a depot and its connected resources.
#
#      {
#        "name"           : string,
#        "latitude"       : number,
#        "longitude"      : number,
#        "areas"          : array,
#        "depotManagerId" : number
#      }
# -----------------------------------------------------------------------------
PUT    /!depot/:id                   |>
{
    "processors": [
        {
            "id"     : 1,
            "method" : "PUT",
            "uri"    : "/depot/:id",
            "fields" : ["name", "latitude", "longitude"]
        },
        {
            "id"     : 2,
            "method" : "DELETE",
            "uri"    : "/depot-manager/~/depot/:id",
            "fields" : []
        },
        {
            "id"     : 3,
            "method" : "PATCH",
            "uri"    : "/depot-manager/~/depot/:id",
            "fields" : ["userId"]
        },
        {
            "id"     : 4,
            "method" : "DELETE",
            "uri"    : "area/~/depot/:id",
            "fields" : []
        },
        {
            "id"     : 5,
            "method" : "PATCH",
            "uri"    : "area/~/depot/:id",
            "fields" : ["areas"]
        }
    ],
    "connections": [
        {
            "destination": 1,
            "filters": [],
            "transformers": []
        },
        {
            "destination": 2,
            "filters": [],
            "transformers": []
        },
        {
            "destination": 3,
            "filters": [],
            "transformers": [
                {
                    "action": "rename",
                    "arguments": ["depotManagerId", "userId"]
                }
            ]
        },
        {
            "destination": 4,
            "filters": [],
            "transformers": []
        },
        {
            "destination": 5,
            "filters": [],
            "transformers": []
        },
        {
            "source": 1,
            "filters": [],
            "transformers": []
        },
        {
            "source": 2,
            "filters": [],
            "transformers": []
        },
        {
            "source": 3,
            "filters": [],
            "transformers": []
        },
        {
            "source": 4,
            "filters": [],
            "transformers": []
        },
        {
            "source": 5,
            "filters": [],
            "transformers": []
        }
    ]
}

# -----------------------------------------------------------------------------
#       Delete a depot.
# -----------------------------------------------------------------------------
DELETE  /depot/:id                    --                                       

         delete from depot 
           where id = {{:id}}

# -----------------------------------------------------------------------------
#      Delete a depot and its connected resources. 
# -----------------------------------------------------------------------------
DELETE /!depot/:id                   |>
{
    "processors": [
        {
            "id"     : 1,
            "method" : "DELETE",
            "uri"    : "/depot-manager/~/depot/:id",
            "fields" : []
        },
        {
            "id"     : 2,
            "method" : "DELETE",
            "uri"    : "/area/~/depot/:id",
            "fields" : ["status"]
        },
        {
            "id"     : 3,
            "method" : "DELETE",
            "uri"    : "/depot/:id",
            "fields" : ["status"]
        }
    ],
    "connections": [
        {
            "destination": 1,
            "filters": [],
            "transformers": []
        },
        {
            "destination": 2,
            "filters": [],
            "transformers": [
                {
                    "action": "include",
                    "arguments": [":id"]
                }
            ]
        },
        {
            "destination": 3,
            "filters": [],
            "transformers": [
                {
                    "action": "include",
                    "arguments": [":id"]
                }
            ]
        },
        {
            "source": 1,
            "destination": 2,
            "filters": [],
            "transformers": []
        },
        {
            "source": 2,
            "destination": 3,
            "filters": [],
            "transformers": []
        },
        {
            "source": 3,
            "filters": [],
            "transformers": []
        }
    ]
}

# -----------------------------------------------------------------------------
#      Retrieve all areas.
# -----------------------------------------------------------------------------
GET    /area                         >>                                       

        ( id
        , regionId
        , name
        , depotId
        , regionName )
                                                                              
        select area.id                                                            
             , area.region_id                                                     
             , area.name                                                          
             , area.depot_id                                                      
             , region.name
        from area                                                            
          join region 
            on region.id = area.region_id
        order by area.id

# -----------------------------------------------------------------------------
#      Create a new area.
# -----------------------------------------------------------------------------
POST   /area                         <>                                       
                                                                              
        insert into area                                                     
          ( region_id, name, depot_id )                                      
        values                                                               
          ( {{regionId}}                                                     
          , {{name}}                                                         
          , {{depotId}}                                                      
          )                        

# -----------------------------------------------------------------------------
#      Delete an area.
# -----------------------------------------------------------------------------
DELETE /area/:id                     --                                       
                                                                              
        delete from area                                                     
          where id = {{:id}}

# -----------------------------------------------------------------------------
#      Update an area.
# -----------------------------------------------------------------------------
PUT    /area/:id                     ><                                       
                                                                              
        update area set name  = {{name}}                                     
                  , region_id = {{regionId}}                                 
                  , depot_id  = {{depotId}}                                  
          where id = {{:id}}

# -----------------------------------------------------------------------------
#      Update an area and its connected resources.
#
#      {
#        "name"           : string,
#        "depotId"        : number,
#        "regionId"       : number,
#        "fieldstaffUser" : number | null,
#        "callcenterUser" : number | null
#      }
# -----------------------------------------------------------------------------
PUT    /!area/:id                    |>  
{
    "processors": [
        {
            "id"     : 1,
            "method" : "PUT",
            "uri"    : "/area/:id",
            "fields" : ["name", "regionId", "depotId"]
        },
        {
            "id"     : 2,
            "method" : "DELETE",
            "uri"    : "/area/:id/~/user",
            "fields" : ["status"]
        },
        {
            "id"     : 3,
            "method" : "PATCH",
            "uri"    : "/area/:id/~/field-staff",
            "fields" : ["status", "userId"]
        },
        {
            "id"     : 4,
            "method" : "PATCH",
            "uri"    : "/area/:id/~/call-center",
            "fields" : ["status", "userId"]
        }
    ],
    "connections": [
        {
            "destination": 1,
            "filters": [],
            "transformers": []
        },
        {
            "source": 1,
            "destination": 2,
            "filters": [
                {
                    "property": "status",
                    "predicate": "equalTo",
                    "value": true
                }
            ],
            "transformers": [
                {
                    "action": "include",
                    "arguments": ["status"]
                }
            ]
        },
        {
            "source": 1,
            "destination": 3,
            "filters": [
                {
                    "property": "status",
                    "predicate": "equalTo",
                    "value": true
                }
            ],
            "transformers": [
                {
                    "action": "include",
                    "arguments": ["status"]
                }
            ]
        },
        {
            "source": 1,
            "destination": 4,
            "filters": [
                {
                    "property": "status",
                    "predicate": "equalTo",
                    "value": true
                }
            ],
            "transformers": [
                {
                    "action": "include",
                    "arguments": ["status"]
                }
            ]
        },
        {
            "destination": 2,
            "filters": [],
            "transformers": [
                {
                    "action": "include",
                    "arguments": [":id"]
                }
            ]
        },
        {
            "destination": 3,
            "filters": [],
            "transformers": [
                {
                    "action": "include",
                    "arguments": [":id", "userId"]
                },
                {
                    "action": "rename",
                    "arguments": ["fieldstaffUser", "userId"]
                }
            ]
        },
        {
            "destination": 4,
            "filters": [],
            "transformers": [
                {
                    "action": "include",
                    "arguments": [":id", "userId"]
                },
                {
                    "action": "rename",
                    "arguments": ["callcenterUser", "userId"]
                }
            ]
        },
        {
            "source": 1,
            "filters": [],
            "transformers": []
        },
        {
            "source": 3,
            "filters": [],
            "transformers": []
        },
        {
            "source": 4,
            "filters": [],
            "transformers": []
        }
    ]
}

# -----------------------------------------------------------------------------
#      Delete an area and its connected resources.
# -----------------------------------------------------------------------------
DELETE /!area/:id                    |>
{
    "processors": [
        {
            "id"     : 1,
            "method" : "DELETE",
            "uri"    : "/area/:id/~/user",
            "fields" : []
        },
        {
            "id"     : 2,
            "method" : "DELETE",
            "uri"    : "/area/:id",
            "fields" : ["status"]
        }
    ],
    "connections": [
        {
            "destination": 1,
            "filters": [],
            "transformers": []
        },
        {
            "destination": 2,
            "filters": [],
            "transformers": []
        },
        {
            "source": 1,
            "destination": 2,
            "filters": [
                {
                    "property": "status",
                    "predicate": "equalTo",
                    "value": true
                }
            ],
            "transformers": []
        },
        {
            "source": 2,
            "filters": [],
            "transformers": []
        }
    ]
}

# -----------------------------------------------------------------------------
#      Retrieve all area-user associations.
# -----------------------------------------------------------------------------
GET    /area-user                    >>                                       

        ( areaId
        , id
        , username
        , name
        , role )

        select area_user.area_id
             , sdrp_user.id
             , sdrp_user.username
             , sdrp_user.name
             , sdrp_user.role
        from area_user
          join sdrp_user
            on sdrp_user.id = area_user.user_id

# -----------------------------------------------------------------------------
#      Set role assignments for an area.
# -----------------------------------------------------------------------------
PATCH  /area/:id/~/:role             ><                                       

        insert into area_user
          ( user_id, area_id )                                               
          ( select {{userId}}                                                
                 , {{:id}}                                                   
            from sdrp_user                                                   
              where role = {{:role}}
                and id   = {{userId}}                                          
          )

# -----------------------------------------------------------------------------
#      Delete all role assignments for an area.
# -----------------------------------------------------------------------------
DELETE /area/:id/~/user              --                                       

        delete from area_user
          where area_id = {{:id}}

# -----------------------------------------------------------------------------
#      Get a list of all regions.
# -----------------------------------------------------------------------------
GET    /region                       >>  

        select id
             , name
        from region 
        order by id

# -----------------------------------------------------------------------------
#      Create a new region.
# -----------------------------------------------------------------------------
POST   /region                       <>  

        insert into region 
          ( name 
          ) values 
          ( {{name}} )

# -----------------------------------------------------------------------------
#      Update a region.
# -----------------------------------------------------------------------------
PUT    /region/:id                   ><  

        update region set name = {{name}} 
          where id = {{:id}}

# -----------------------------------------------------------------------------
#      Delete a region.
# -----------------------------------------------------------------------------
DELETE /region/:id                   --                                       
                                                                              
        delete from region
          where id = {{:id}}

# -----------------------------------------------------------------------------
#      Get a list of all vehicles.
# -----------------------------------------------------------------------------
GET    /vehicle                      >>  

        ( id
        , regNo
        , depotId
        , driverId
        , isAvailable
        , make
        , model
        , status
        , weightCatId
        , driverName
        , driverUsername )

        select vehicle.id
             , vehicle.reg_no
             , vehicle.depot_id
             , vehicle.user_id
             , vehicle.is_available
             , vehicle.make
             , vehicle.model
             , vehicle.status
             , vehicle.category_id
             , sdrp_user.name
             , sdrp_user.username
        from vehicle 
          left join sdrp_user 
            on sdrp_user.id = vehicle.user_id
        order by 
          vehicle.id

# -----------------------------------------------------------------------------
#      Create a new vehicle.
# -----------------------------------------------------------------------------
POST   /vehicle                      <>
                                                                              
        insert into vehicle
          ( reg_no
          , depot_id
          , user_id
          , is_available
          , make
          , model
          , status
          , category_id 
          ) values                                                               
          ( {{regNo}}          
          , {{depotId}}
          , {{userId}}
          , {{isAvailable}}
          , {{make}}
          , {{model}}
          , {{status}}
          , {{categoryId}}
          )                        

# -----------------------------------------------------------------------------
#      Update a vehicle.
# -----------------------------------------------------------------------------
PUT    /vehicle/:id                  ><
        
        update vehicle set reg_no       = {{regNo}}
                         , depot_id     = {{depotId}}
                         , user_id      = {{userId}}
                         , is_available = {{isAvailable}}
                         , make         = {{make}}
                         , model        = {{model}}
                         , status       = {{status}}
                         , category_id  = {{categoryId}}
          where id = {{:id}}

# -----------------------------------------------------------------------------
#      Delete a vehicle.
# -----------------------------------------------------------------------------
DELETE /vehicle/:id                  --                                       
                                                                              
        delete from vehicle
          where id = {{:id}}

# -----------------------------------------------------------------------------
#      Get a list of all vehicle weight categories.
# -----------------------------------------------------------------------------
GET    /weight-category              >>  

        select id
             , name
        from weight_category 
        order by 
          weight_category.id

# -----------------------------------------------------------------------------
#      Insert a new vehicle weight category.
# -----------------------------------------------------------------------------
POST   /weight-category              <>  

        insert into weight_category 
          ( name 
          ) values 
          ( {{name}} )

# -----------------------------------------------------------------------------
#      Update a vehicle weight category.
# -----------------------------------------------------------------------------
PUT    /weight-category/:id          ><  

        update weight_category set name = {{name}} 
          where id = {{:id}}

# -----------------------------------------------------------------------------
#      Get stock availability information for a depot. 
# -----------------------------------------------------------------------------
GET    /stock/depot/:id              >>  

        ( productId
        , actual
        , available
        , productName ) 
        
        select stock.product_id
             , stock.actual
             , stock.available
             , product.name 
        from stock 
          join product 
            on product.id = stock.product_id 
          where depot_id = {{:id}} 
        order by 
          stock.id

# -----------------------------------------------------------------------------
#      Retrieve a list of all customers.
# -----------------------------------------------------------------------------
GET    /customer                     >>                                       
                                                                              
        ( id                                                                 
        , name                                                               
        , address                                                      
        , created                                                            
        , latitude                                                           
        , longitude                                                          
        , tin                                                                
        , phone                                                              
        , isActive                                                           
        , areaId                                                             
        , priceCatId                                                         
        , areaName                                                           
        , priceCategory )                                                                    
                                                                             
        select customer.id                                                   
             , customer.name                                                 
             , customer.address                                       
             , customer.created                                              
             , customer.latitude                                             
             , customer.longitude                                            
             , customer.tin                                                  
             , customer.phone                                                
             , customer.is_active                                            
             , customer.area_id                                              
             , customer.price_cat_id                                         
             , area.name                                                     
             , product_price_category.name                                   
        from customer                                                        
          join area                                                          
            on area.id = customer.area_id                                    
          join product_price_category                                        
            on product_price_category.id = customer.price_cat_id             
        order by                                                             
          customer.id

# -----------------------------------------------------------------------------
#      Insert a new customer.
# -----------------------------------------------------------------------------
POST   /customer                     <>                                       
                                                                              
        insert into customer                                                 
          ( name                                                               
          , address                                                     
          , latitude                                                           
          , longitude                                                          
          , tin                                                                
          , phone                                                              
          , is_active                                                          
          , area_id                                                            
          , price_cat_id                                                       
          ) values                                                             
          ( {{name}}                                                         
          , {{address}}                                                
          , {{latitude}}                                                     
          , {{longitude}}                                                    
          , {{tin}}                                                          
          , {{phone}}                                                        
          , {{isActive}}                                                     
          , {{areaId}}                                                       
          , {{priceCatId}}                                                   
          )

# -----------------------------------------------------------------------------
#      Update a customer.
# -----------------------------------------------------------------------------
PUT    /customer/:id                 ><  

        update customer set name           = {{name}}
                          , address        = {{address}}
                          , latitude       = {{latitude}}
                          , longitude      = {{longitude}}
                          , tin            = {{tin}}
                          , phone          = {{phone}}
                          , is_active      = {{isActive}}
                          , area_id        = {{areaId}}
                          , price_cat_id   = {{priceCatId}} 
          where id = {{:id}}

# -----------------------------------------------------------------------------
#      Get all contact details for a customer.
# -----------------------------------------------------------------------------
GET    /contact/customer/:id         >>                                       
                                                                              
        select customer_id
             , id
             , kind
             , datum 
             , meta                                                            
        from customer_contact                                                
          where customer_id = {{:id}}                                        
        group by                                                             
          id, kind                                                           
        order by id 

# -----------------------------------------------------------------------------
#      Fetch a single contact.
# -----------------------------------------------------------------------------
GET    /contact/:id                  ->  

        ( customerId
        , id
        , kind
        , datum
        , meta
        , customerName )

        select customer_contact.customer_id
             , customer_contact.id
             , customer_contact.kind
             , customer_contact.datum
             , customer_contact.meta                                                            
             , customer.name
         from customer_contact 
           join customer 
             on customer.id = customer_contact.customer_id
          where customer_contact.id = {{:id}}

# -----------------------------------------------------------------------------
#      Insert a new customer contact.
# -----------------------------------------------------------------------------
POST   /contact                      <>  

        insert into customer_contact 
          ( customer_id
          , kind
          , datum
          , meta
          ) values 
          ( {{customerId}}
          , {{kind}}
          , {{datum}}
          , {{meta}}
          )

# -----------------------------------------------------------------------------
#      Update a customer contact.
# -----------------------------------------------------------------------------
PUT    /contact/:id                  ><  

        update customer_contact set customer_id = {{customerId}}
                                  , kind        = {{kind}}
                                  , datum       = {{datum}}
                                  , meta        = {{meta}} 
          where id = {{:id}}

# -----------------------------------------------------------------------------
#      Delete a customer contact.
# -----------------------------------------------------------------------------
DELETE /contact/:id                  --

        delete from customer_contact
          where id = {{:id}}

# -----------------------------------------------------------------------------
#      Get all product price categories.
# -----------------------------------------------------------------------------
GET    /price-category               >>                                       
                                                                              
        select id, name                                                      
        from product_price_category                                          
        order by id

# -----------------------------------------------------------------------------
#      Create a new product price category.
# -----------------------------------------------------------------------------
POST   /price-category               <>  

        insert into product_price_category
          ( name 
          ) values 
          ( {{name}} )

# -----------------------------------------------------------------------------
#      Update a price category.
# -----------------------------------------------------------------------------
PUT    /price-category/:id           ><  
                                                                              
        update product_price_category set name = {{name}}                                     
          where id = {{:id}}

# -----------------------------------------------------------------------------
#      Delete a price category.
# -----------------------------------------------------------------------------
DELETE /price-category/:id           --

        delete from product_price_category
          where id = {{:id}}

# -----------------------------------------------------------------------------
#      Get a list of all stock damage types.
# -----------------------------------------------------------------------------
GET    /stock-damage-type            >>  

        select id
             , name
        from stock_damage_type 
        order by id

# -----------------------------------------------------------------------------
#      Create a new stock damage type.
# -----------------------------------------------------------------------------
POST   /stock-damage-type            <>  

        insert into stock_damage_type 
          ( name 
          ) values 
          ( {{name}} )

# -----------------------------------------------------------------------------
#      Update a stock damage type.
# -----------------------------------------------------------------------------
PUT    /stock-damage-type/:id        ><  

        update stock_damage_type set name = {{name}} 
          where id = {{:id}}

# -----------------------------------------------------------------------------
#      Delete stock damage type.
# -----------------------------------------------------------------------------
DELETE /stock-damage-type/:id        --  

        delete from stock_damage_type 
          where id = {{:id}}

